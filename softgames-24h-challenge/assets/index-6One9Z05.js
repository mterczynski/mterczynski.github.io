var H=Object.defineProperty;var j=(a,t,e)=>t in a?H(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var g=(a,t,e)=>j(a,typeof t!="symbol"?t+"":t,e);import{C as N,T as _,S as b,d as W,a as E,f as F,e as y,G,c as O,b as B,A as L}from"./createFullscreenPixiApp-Dd3U93Po.js";import"./index-DUmRFgfu.js";const m={initialCanvasWidth:960,initialCanvasHeight:800,apiUrl:"https://private-624120-softgamesassignment.apiary-mock.com/v2/magicwords",backgroundFadeOutDurationMs:1100,theEndFadeInDurationMs:1e3};class P extends N{constructor(t){super(),this.init(t)}init(t){const e=_.from(t),i=new b(e);this.addChild(i)}}class X{constructor(t,e,i){g(this,"characterMap",new Map);g(this,"dialogueIndex",0);g(this,"dialogueContainer",null);g(this,"currentSpeaker",null);g(this,"theEndText",null);g(this,"hasShownTheEnd",!1);g(this,"clearDialogue",(t=!0)=>{this.dialogueContainer&&this.app.stage.removeChild(this.dialogueContainer),t&&this.currentSpeaker&&(this.app.stage.removeChild(this.currentSpeaker),this.currentSpeaker=null)});g(this,"showNextDialogue",()=>{var l;if(this.clearDialogue(),this.dialogueIndex>=this.data.dialogue.length){this.hasShownTheEnd||(this.hasShownTheEnd=!0,this.fadeOutBackgroundAndShowTheEnd());return}const t=this.data.dialogue[this.dialogueIndex],{character:e,displayName:i}=this.getSpeaker(t),n=this.app.screen.width,c=this.app.screen.height,d=n<600?12:60,s=n-d*2,o=24;this.dialogueContainer=this.renderDialogueLine(t.text,this.data.emojies,i,!e,s),e&&((l=this.data.avatars.find(p=>p.name===i))==null?void 0:l.position)==="left"?(this.dialogueContainer.x=d,this.dialogueContainer.y=e.y-this.dialogueContainer.height-o):e?(this.dialogueContainer.x=n-this.dialogueContainer.width-d,this.dialogueContainer.y=e.y-this.dialogueContainer.height-o):(this.dialogueContainer.x=d,this.dialogueContainer.y=(c-this.dialogueContainer.height)/2),this.app.stage.addChild(this.dialogueContainer),this.dialogueIndex++,this.resizeDialogue(n,c)});this.app=t,this.data=e,this.background=i,this.createCharacterMap()}createCharacterMap(){this.characterMap.clear();for(const t of this.data.avatars){const e=new P(t.url);t.position==="left"?e.x=170:e.x=this.app.screen.width-350,this.characterMap.set(t.name,e)}}start(){this.dialogueIndex=0,this.dialogueContainer=null,this.currentSpeaker=null,this.showNextDialogue(),this.app.view.addEventListener("pointerdown",this.showNextDialogue)}onResize(t,e){if(this.dialogueIndex>=this.data.dialogue.length){if(this.clearDialogue(!0),this.theEndText){const i=Math.max(32,Math.min(96,Math.floor(t*.08)));this.theEndText.style=new W({fill:16777215,fontSize:i,fontWeight:"bold",fontFamily:"Arial",align:"center",dropShadow:!0,dropShadowColor:0,dropShadowBlur:8}),this.theEndText.x=t/2,this.theEndText.y=e/2}return}this.resizeCharacter(t,e),this.resizeDialogue(t,e)}resizeCharacter(t,e){for(const[d,s]of this.characterMap){const o=this.data.avatars.find(p=>p.name===d);if(!o)continue;const l=Math.max(24,Math.min(t*.08,120));o.position==="left"?s.x=l:s.x=t-128-l,s.y=e-400}}resizeDialogue(t,e){var d;const n=t<600?12:60,c=t-n*2,r=10;if(this.dialogueContainer&&this.dialogueIndex>0){const s=this.data.dialogue[this.dialogueIndex-1],{character:o,displayName:l}=this.getSpeaker(s);this.app.stage.removeChild(this.dialogueContainer),this.dialogueContainer=this.renderDialogueLine(s.text,this.data.emojies,l,!o,c),o&&((d=this.data.avatars.find(p=>p.name===l))==null?void 0:d.position)==="left"?(this.dialogueContainer.x=n,this.dialogueContainer.y=o.y-this.dialogueContainer.height-r):o?(this.dialogueContainer.x=t-this.dialogueContainer.width-n,this.dialogueContainer.y=o.y-this.dialogueContainer.height-r):(this.dialogueContainer.x=n,this.dialogueContainer.y=(e-this.dialogueContainer.height)/2),this.app.stage.addChild(this.dialogueContainer)}else this.dialogueContainer&&(this.dialogueContainer.x=n,this.dialogueContainer.y=e-this.dialogueContainer.height-r)}getSpeaker(t,e=!0){const i=this.characterMap.get(t.name);return i?(e&&this.app.stage.addChild(i),this.currentSpeaker=i,{character:i,displayName:t.name}):{character:null,displayName:t.name}}renderDialogueLine(t,e,i,n=!1,c=480){const r=new N;let d=0,s=0,o=0;const l=8,p=4,S=28,v={fill:0,fontSize:20,fontFamily:"Arial",fontWeight:"bold"};if(n){const h=new E(`${i}:`,{...v,fontSize:18});h.x=0,h.y=0,r.addChild(h),d=h.height+4}const R=t.split(/({[^}]+})/g).filter(Boolean);let k=[];for(const h of R){const u=h.match(/^{(.+)}$/);if(u)k.push({type:"emoji",value:u[1]});else{const f=h.split(/(\s+)/g).filter(Boolean);for(const C of f)k.push({type:"text",value:C})}}let I=d,M=0;s=0;for(const h of k){let u,f=0,C=0;if(h.type==="emoji"){const w=e.find(x=>x.name===h.value);if(w){const x=b.from(w.url);x.width=x.height=S,u=x,f=S+4,C=S}else{const x=`(${h.value} tone)`,A=new E(x,v);u=A,f=A.width+4,C=A.height}}else{const w=new E(h.value,v);u=w,f=w.width,C=w.height}(h.type!=="text"||h.value.trim()!=="")&&s+f>c-l&&s>0&&(s=0,I+=M+p,M=0),u.x=s,u.y=I,r.addChild(u),s+=f,C>M&&(M=C),s>o&&(o=s)}const z=I+M+l/2,T=new F;return T.beginFill(16777215,1),T.drawRoundedRect(-8/2,-8/2,Math.max(o+l,120),z,12),T.endFill(),r.addChildAt(T,0),r}fadeOutBackgroundAndShowTheEnd(){const t=m.backgroundFadeOutDurationMs;new y.Tween(this.background,D).to({alpha:0},t).easing(y.Easing.Quadratic.Out).onComplete(()=>{this.showTheEnd()}).start()}showTheEnd(){const t=this.app.screen.width,e=this.app.screen.height;this.theEndText&&this.theEndText.parent&&this.theEndText.parent.removeChild(this.theEndText);const i=Math.max(32,Math.min(96,Math.floor(t*.08)));this.theEndText=new E("The end",{fill:16777215,fontSize:i,fontWeight:"bold",fontFamily:"Arial",align:"center",dropShadow:!0,dropShadowColor:0,dropShadowBlur:8}),this.theEndText.anchor.set(.5),this.theEndText.x=t/2,this.theEndText.y=e/2,this.theEndText.alpha=0,this.app.stage.addChild(this.theEndText),new y.Tween(this.theEndText,D).to({alpha:1},m.theEndFadeInDurationMs).easing(y.Easing.Quadratic.InOut).start()}}const D=new G;async function K(){const{app:a}=O({width:m.initialCanvasWidth,height:m.initialCanvasHeight,tweenGroup:D}),t=await $(),e=await Q();a.stage.addChild(t);const i=new X(a,e,t);i.start();const n=B();a.ticker.add(()=>{var r;(r=n==null?void 0:n.update)==null||r.call(n)});function c(){t.width=a.renderer.width,t.height=a.renderer.height,i.onResize&&i.onResize(a.renderer.width,a.renderer.height)}return window.addEventListener("resize",c),c(),a}async function $(){const a="./assets/bbt-background.jpg";await L.load(a);const t=b.from(a);return t.width=m.initialCanvasWidth,t.height=m.initialCanvasHeight,t.alpha=.35,t}async function Q(){const t=(await fetch(m.apiUrl)).json();return t.then(e=>{e.avatars.forEach(i=>{fetch(i.url)}),e.emojies.forEach(i=>{fetch(i.url)})}),t}export{K as init,D as tweenGroup};
