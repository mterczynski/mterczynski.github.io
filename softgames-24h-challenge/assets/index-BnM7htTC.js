var H=Object.defineProperty;var j=(n,t,e)=>t in n?H(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var g=(n,t,e)=>j(n,typeof t!="symbol"?t+"":t,e);import{C as N,T as _,S as b,d as F,a as T,f as G,e as E,G as W,c as O,b as X,A as B}from"./createFullscreenPixiApp-DMxosKZZ.js";import"./index-DvdLGKk5.js";const x={initialCanvasWidth:960,initialCanvasHeight:800,apiUrl:"https://private-624120-softgamesassignment.apiary-mock.com/v2/magicwords",backgroundFadeOutDurationMs:1100,theEndFadeInDurationMs:1e3};class L extends N{constructor(t){super(),this.init(t)}init(t){const e=_.from(t),i=new b(e);this.addChild(i)}}class P{constructor(t,e,i){g(this,"characterMap",new Map);g(this,"dialogueIndex",0);g(this,"dialogueContainer",null);g(this,"currentSpeaker",null);g(this,"theEndText",null);g(this,"hasShownTheEnd",!1);g(this,"clearDialogue",(t=!0)=>{this.dialogueContainer&&this.app.stage.removeChild(this.dialogueContainer),t&&this.currentSpeaker&&(this.app.stage.removeChild(this.currentSpeaker),this.currentSpeaker=null)});g(this,"showNextDialogue",()=>{var d;if(this.clearDialogue(),this.dialogueIndex>=this.data.dialogue.length){this.hasShownTheEnd||(this.hasShownTheEnd=!0,this.fadeOutBackgroundAndShowTheEnd());return}const t=this.data.dialogue[this.dialogueIndex],{character:e,displayName:i}=this.getSpeaker(t),o=this.app.screen.width,r=this.app.screen.height,s=this.getMarginX(o),c=o-s*2,a=24;this.dialogueContainer=this.renderDialogueLine(t.text,this.data.emojies,i,!e,c),e&&((d=this.data.avatars.find(l=>l.name===i))==null?void 0:d.position)==="left"?(this.dialogueContainer.x=s,this.dialogueContainer.y=e.y-this.dialogueContainer.height-a):e?(this.dialogueContainer.x=o-this.dialogueContainer.width-s,this.dialogueContainer.y=e.y-this.dialogueContainer.height-a):(this.dialogueContainer.x=s,this.dialogueContainer.y=(r-this.dialogueContainer.height)/2),this.app.stage.addChild(this.dialogueContainer),this.dialogueIndex++,this.resizeDialogue(o,r)});this.app=t,this.data=e,this.background=i,this.createCharacterMap()}createCharacterMap(){this.characterMap.clear();for(const t of this.data.avatars){const e=new L(t.url);t.position==="left"?e.x=170:e.x=this.app.screen.width-350,this.characterMap.set(t.name,e)}}start(){this.dialogueIndex=0,this.dialogueContainer=null,this.currentSpeaker=null,this.showNextDialogue(),this.app.view.addEventListener("pointerdown",this.showNextDialogue)}onResize(t,e){if(this.dialogueIndex>=this.data.dialogue.length){if(this.clearDialogue(!0),this.theEndText){const i=Math.max(32,Math.min(96,Math.floor(t*.08)));this.theEndText.style=new F({fill:16777215,fontSize:i,fontWeight:"bold",fontFamily:"Arial",align:"center",dropShadow:!0,dropShadowColor:0,dropShadowBlur:8}),this.theEndText.x=t/2,this.theEndText.y=e/2}return}this.resizeCharacter(t,e),this.resizeDialogue(t,e)}resizeCharacter(t,e){for(const[c,a]of this.characterMap){const d=this.data.avatars.find(y=>y.name===c);if(!d)continue;const l=Math.max(24,Math.min(t*.08,120));d.position==="left"?a.x=l:a.x=t-128-l,a.y=e-(this.isMobile(t)?400:460)}}isMobile(t){return t<600}getMarginX(t){return this.isMobile(t)?12:60}resizeDialogue(t,e){var s;const i=this.getMarginX(t),o=t-i*2,r=10;if(this.dialogueContainer&&this.dialogueIndex>0){const c=this.data.dialogue[this.dialogueIndex-1],{character:a,displayName:d}=this.getSpeaker(c);this.app.stage.removeChild(this.dialogueContainer),this.dialogueContainer=this.renderDialogueLine(c.text,this.data.emojies,d,!a,o),a&&((s=this.data.avatars.find(l=>l.name===d))==null?void 0:s.position)==="left"?(this.dialogueContainer.x=i,this.dialogueContainer.y=a.y-this.dialogueContainer.height-r):a?(this.dialogueContainer.x=t-this.dialogueContainer.width-i,this.dialogueContainer.y=a.y-this.dialogueContainer.height-r):(this.dialogueContainer.x=i,this.dialogueContainer.y=(e-this.dialogueContainer.height)/2),this.app.stage.addChild(this.dialogueContainer)}else this.dialogueContainer&&(this.dialogueContainer.x=i,this.dialogueContainer.y=e-this.dialogueContainer.height-r)}getSpeaker(t,e=!0){const i=this.characterMap.get(t.name);return i?(e&&this.app.stage.addChild(i),this.currentSpeaker=i,{character:i,displayName:t.name}):{character:null,displayName:t.name}}renderDialogueLine(t,e,i,o=!1,r=480){const s=new N;let c=0,a=0,d=0;const l=8,y=4,S=28,v={fill:0,fontSize:20,fontFamily:"Arial",fontWeight:"bold"};if(o){const h=new T(`${i}:`,{...v,fontSize:18});h.x=0,h.y=0,s.addChild(h),c=h.height+4}const R=t.split(/({[^}]+})/g).filter(Boolean);let k=[];for(const h of R){const u=h.match(/^{(.+)}$/);if(u)k.push({type:"emoji",value:u[1]});else{const p=h.split(/(\s+)/g).filter(Boolean);for(const f of p)k.push({type:"text",value:f})}}let I=c,w=0;a=0;for(const h of k){let u,p=0,f=0;if(h.type==="emoji"){const m=e.find(C=>C.name===h.value);if(m){const C=b.from(m.url);C.width=C.height=S,u=C,p=S+4,f=S}else{const C=`(${h.value} tone)`,A=new T(C,v);u=A,p=A.width+4,f=A.height}}else{const m=new T(h.value,v);u=m,p=m.width,f=m.height}(h.type!=="text"||h.value.trim()!=="")&&a+p>r-l&&a>0&&(a=0,I+=w+y,w=0),u.x=a,u.y=I,s.addChild(u),a+=p,f>w&&(w=f),a>d&&(d=a)}const z=I+w+l/2,M=new G;return M.beginFill(16777215,1),M.drawRoundedRect(-8/2,-8/2,Math.max(d+l,120),z,12),M.endFill(),s.addChildAt(M,0),s}fadeOutBackgroundAndShowTheEnd(){const t=x.backgroundFadeOutDurationMs;new E.Tween(this.background,D).to({alpha:0},t).easing(E.Easing.Quadratic.Out).onComplete(()=>{this.showTheEnd()}).start()}showTheEnd(){const t=this.app.screen.width,e=this.app.screen.height;this.theEndText&&this.theEndText.parent&&this.theEndText.parent.removeChild(this.theEndText);const i=Math.max(32,Math.min(96,Math.floor(t*.08)));this.theEndText=new T("The end",{fill:16777215,fontSize:i,fontWeight:"bold",fontFamily:"Arial",align:"center",dropShadow:!0,dropShadowColor:0,dropShadowBlur:8}),this.theEndText.anchor.set(.5),this.theEndText.x=t/2,this.theEndText.y=e/2,this.theEndText.alpha=0,this.app.stage.addChild(this.theEndText),new E.Tween(this.theEndText,D).to({alpha:1},x.theEndFadeInDurationMs).easing(E.Easing.Quadratic.InOut).start()}}const D=new W;async function K(){const{app:n}=O({width:x.initialCanvasWidth,height:x.initialCanvasHeight,globalTweenGroup:D}),t=await $(),e=await Q();n.stage.addChild(t);const i=new P(n,e,t);i.start();const o=X();n.ticker.add(()=>{var s;(s=o==null?void 0:o.update)==null||s.call(o)});function r(){t.width=n.renderer.width,t.height=n.renderer.height,i.onResize&&i.onResize(n.renderer.width,n.renderer.height)}return window.addEventListener("resize",r),r(),n}async function $(){const n="./assets/bbt-background.jpg";await B.load(n);const t=b.from(n);return t.width=x.initialCanvasWidth,t.height=x.initialCanvasHeight,t.alpha=.35,t}async function Q(){const t=(await fetch(x.apiUrl)).json();return t.then(e=>{e.avatars.forEach(i=>{fetch(i.url)}),e.emojies.forEach(i=>{fetch(i.url)})}),t}export{D as globalTweenGroup,K as init};
